<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Dashboard - Pro Trading Platform</title>
    <link rel="stylesheet" href="animations.css">
    <style>
        /* ============================================
           Color Scheme & Design Tokens
           ============================================ */
        :root {
            /* Primary Colors */
            --color-bg-primary: #0a0e27;
            --color-bg-secondary: #141824;
            --color-bg-card: #1a1f37;
            --color-bg-card-hover: #242a45;

            /* Accent Colors */
            --color-accent-primary: #3b82f6;
            --color-accent-secondary: #8b5cf6;

            /* Stock Colors - Carefully chosen for accessibility */
            --color-gain: #10b981;
            --color-gain-bg: rgba(16, 185, 129, 0.1);
            --color-gain-hover: #059669;
            --color-loss: #ef4444;
            --color-loss-bg: rgba(239, 68, 68, 0.1);
            --color-loss-hover: #dc2626;
            --color-neutral: #64748b;

            /* Text Colors */
            --color-text-primary: #f8fafc;
            --color-text-secondary: #94a3b8;
            --color-text-muted: #64748b;

            /* Border & Shadow */
            --color-border: #2d3548;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);

            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;

            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-base: 250ms ease-in-out;
            --transition-slow: 350ms ease-in-out;
        }

        /* ============================================
           Base Styles & Reset
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============================================
           Layout Components
           ============================================ */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--color-bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-title h1 {
            font-size: 1.875rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--color-gain);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Controls Bar */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 2.75rem;
            background: var(--color-bg-card);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 1rem;
            transition: all var(--transition-base);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
        }

        .filter-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--color-bg-card);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .filter-btn:hover {
            background: var(--color-bg-card-hover);
            border-color: var(--color-accent-primary);
            color: var(--color-text-primary);
        }

        .filter-btn.active {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            color: white;
        }

        .refresh-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--color-accent-primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .refresh-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        /* Stock Grid */
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stock-card {
            background: var(--color-bg-card);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stock-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-accent-primary), var(--color-accent-secondary));
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .stock-card:hover {
            border-color: var(--color-accent-primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .stock-card:hover::before {
            opacity: 1;
        }

        .stock-card.gain {
            border-color: var(--color-gain);
        }

        .stock-card.loss {
            border-color: var(--color-loss);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
        }

        .stock-symbol {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .stock-name {
            font-size: 0.875rem;
            color: var(--color-text-muted);
            margin-top: var(--spacing-xs);
        }

        .watchlist-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watchlist-btn:hover {
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .watchlist-btn.active {
            border-color: #fbbf24;
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .stock-price {
            font-size: 2rem;
            font-weight: 700;
            margin: var(--spacing-md) 0;
        }

        .stock-change {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .stock-change.gain {
            background: var(--color-gain-bg);
            color: var(--color-gain);
        }

        .stock-change.loss {
            background: var(--color-loss-bg);
            color: var(--color-loss);
        }

        .stock-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            min-height: 400px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: var(--spacing-lg);
            font-size: 1rem;
            color: var(--color-text-secondary);
        }

        /* Error State */
        .error-container {
            background: var(--color-bg-card);
            border: 2px solid var(--color-loss);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            max-width: 500px;
            margin: var(--spacing-xl) auto;
        }

        .error-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .error-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-loss);
            margin-bottom: var(--spacing-sm);
        }

        .error-message {
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-lg);
        }

        .retry-btn {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--color-accent-primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .retry-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            text-align: center;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity var(--transition-fast);
            pointer-events: none;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Keyboard Shortcuts Panel */
        .shortcuts-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-bg-card);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            display: none;
        }

        .shortcuts-panel.show {
            display: block;
            animation: fadeInScale 0.3s ease-out;
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .shortcuts-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .close-btn:hover {
            color: var(--color-text-primary);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .shortcut-item:last-child {
            border-bottom: none;
        }

        .shortcut-description {
            color: var(--color-text-secondary);
        }

        .shortcut-key {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* Help Button */
        .help-btn {
            position: fixed;
            bottom: var(--spacing-xl);
            right: var(--spacing-xl);
            width: 56px;
            height: 56px;
            background: var(--color-accent-primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
            z-index: 100;
        }

        .help-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        /* Responsive Design - Mobile First */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: var(--spacing-md);
            }

            .dashboard-header {
                flex-direction: column;
                align-items: start;
                gap: var(--spacing-md);
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .stock-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }

            .controls-bar {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            .filter-buttons {
                width: 100%;
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .help-btn {
                bottom: var(--spacing-md);
                right: var(--spacing-md);
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }
        }

        /* Accessibility - Focus States */
        *:focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            .help-btn,
            .refresh-btn,
            .filter-buttons {
                display: none;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --color-border: #475569;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Dashboard Header -->
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-title">
                <h1>Stock Market Dashboard</h1>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    <span>Live Market Data</span>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div class="tooltip">
                    <span id="lastUpdate" style="font-size: 0.875rem; color: var(--color-text-secondary);">
                        Last updated: --:--:--
                    </span>
                    <span class="tooltip-text">Auto-refresh every 30 seconds</span>
                </div>
            </div>
        </header>

        <!-- Controls Bar -->
        <div class="controls-bar">
            <div class="search-box">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                <input type="text" id="searchInput" placeholder="Search stocks by symbol or name..." aria-label="Search stocks">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" aria-label="Show all stocks">All</button>
                <button class="filter-btn" data-filter="gain" aria-label="Show only gaining stocks">Gainers</button>
                <button class="filter-btn" data-filter="loss" aria-label="Show only losing stocks">Losers</button>
                <button class="filter-btn" data-filter="watchlist" aria-label="Show watchlist only">Watchlist</button>
            </div>
            <button class="refresh-btn" id="refreshBtn" aria-label="Refresh stock data">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 104.546 2.914.5.5 0 00-.908-.417A4 4 0 118 4v1l1.5-1.5L8 2v1z" clip-rule="evenodd" />
                </svg>
                Refresh
            </button>
        </div>

        <!-- Stock Grid -->
        <div id="stockGrid" class="stock-grid">
            <!-- Stock cards will be dynamically inserted here -->
        </div>
    </div>

    <!-- Keyboard Shortcuts Panel -->
    <div class="overlay" id="overlay"></div>
    <div class="shortcuts-panel" id="shortcutsPanel" role="dialog" aria-labelledby="shortcutsTitle">
        <div class="shortcuts-header">
            <h2 class="shortcuts-title" id="shortcutsTitle">Keyboard Shortcuts</h2>
            <button class="close-btn" id="closeShortcuts" aria-label="Close shortcuts panel">&times;</button>
        </div>
        <div class="shortcuts-list">
            <div class="shortcut-item">
                <span class="shortcut-description">Show this help panel</span>
                <span class="shortcut-key">?</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-description">Refresh data</span>
                <span class="shortcut-key">R</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-description">Focus search</span>
                <span class="shortcut-key">/</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-description">Show all stocks</span>
                <span class="shortcut-key">1</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-description">Show gainers only</span>
                <span class="shortcut-key">2</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-description">Show losers only</span>
                <span class="shortcut-key">3</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-description">Show watchlist</span>
                <span class="shortcut-key">4</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-description">Close panel</span>
                <span class="shortcut-key">ESC</span>
            </div>
        </div>
    </div>

    <!-- Help Button -->
    <button class="help-btn" id="helpBtn" aria-label="Show keyboard shortcuts">?</button>

    <script>
        // ============================================
        // Application State
        // ============================================
        let stocks = [];
        let filteredStocks = [];
        let watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
        let currentFilter = 'all';
        let autoRefreshInterval = null;

        // ============================================
        // Mock Data Generator
        // ============================================
        function generateMockStocks() {
            const companies = [
                { symbol: 'AAPL', name: 'Apple Inc.', basePrice: 175.50 },
                { symbol: 'GOOGL', name: 'Alphabet Inc.', basePrice: 140.25 },
                { symbol: 'MSFT', name: 'Microsoft Corp.', basePrice: 380.00 },
                { symbol: 'AMZN', name: 'Amazon.com Inc.', basePrice: 155.75 },
                { symbol: 'TSLA', name: 'Tesla Inc.', basePrice: 242.50 },
                { symbol: 'META', name: 'Meta Platforms', basePrice: 485.00 },
                { symbol: 'NVDA', name: 'NVIDIA Corp.', basePrice: 495.25 },
                { symbol: 'NFLX', name: 'Netflix Inc.', basePrice: 485.50 },
                { symbol: 'AMD', name: 'Advanced Micro Devices', basePrice: 145.80 },
                { symbol: 'INTC', name: 'Intel Corp.', basePrice: 43.50 },
                { symbol: 'BABA', name: 'Alibaba Group', basePrice: 78.90 },
                { symbol: 'V', name: 'Visa Inc.', basePrice: 252.30 }
            ];

            return companies.map(company => {
                const changePercent = (Math.random() - 0.5) * 10; // -5% to +5%
                const changeAmount = (company.basePrice * changePercent) / 100;
                const currentPrice = company.basePrice + changeAmount;
                const volume = Math.floor(Math.random() * 50000000) + 10000000;
                const marketCap = (currentPrice * Math.floor(Math.random() * 10000000000)) / 1000000;

                return {
                    symbol: company.symbol,
                    name: company.name,
                    price: currentPrice,
                    change: changeAmount,
                    changePercent: changePercent,
                    volume: volume,
                    marketCap: marketCap,
                    high: currentPrice * 1.02,
                    low: currentPrice * 0.98
                };
            });
        }

        // ============================================
        // Utility Functions
        // ============================================
        function formatPrice(price) {
            return `$${price.toFixed(2)}`;
        }

        function formatLargeNumber(num) {
            if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
            if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            return `$${num.toFixed(0)}`;
        }

        function formatVolume(volume) {
            if (volume >= 1e9) return `${(volume / 1e9).toFixed(2)}B`;
            if (volume >= 1e6) return `${(volume / 1e6).toFixed(2)}M`;
            if (volume >= 1e3) return `${(volume / 1e3).toFixed(2)}K`;
            return volume.toString();
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `Last updated: ${timeString}`;
        }

        // ============================================
        // UI Rendering Functions
        // ============================================
        function showLoading() {
            const grid = document.getElementById('stockGrid');
            grid.innerHTML = `
                <div class="loading-container" style="grid-column: 1 / -1;">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Loading market data...</p>
                </div>
            `;
        }

        function showError(message) {
            const grid = document.getElementById('stockGrid');
            grid.innerHTML = `
                <div class="error-container" style="grid-column: 1 / -1;">
                    <div class="error-icon">⚠️</div>
                    <h3 class="error-title">Unable to Load Data</h3>
                    <p class="error-message">${message}</p>
                    <button class="retry-btn" onclick="loadStocks()">Try Again</button>
                </div>
            `;
        }

        function createStockCard(stock) {
            const isGain = stock.changePercent >= 0;
            const isInWatchlist = watchlist.includes(stock.symbol);
            const changeClass = isGain ? 'gain' : 'loss';
            const changeIcon = isGain ? '▲' : '▼';

            return `
                <article class="stock-card ${changeClass}" data-symbol="${stock.symbol}">
                    <div class="stock-header">
                        <div>
                            <h3 class="stock-symbol">${stock.symbol}</h3>
                            <p class="stock-name">${stock.name}</p>
                        </div>
                        <button class="watchlist-btn ${isInWatchlist ? 'active' : ''}"
                                onclick="toggleWatchlist('${stock.symbol}')"
                                aria-label="${isInWatchlist ? 'Remove from' : 'Add to'} watchlist">
                            ${isInWatchlist ? '★' : '☆'}
                        </button>
                    </div>
                    <div class="stock-price">${formatPrice(stock.price)}</div>
                    <div class="stock-change ${changeClass}">
                        <span>${changeIcon}</span>
                        <span>${formatPrice(Math.abs(stock.change))} (${Math.abs(stock.changePercent).toFixed(2)}%)</span>
                    </div>
                    <div class="stock-details">
                        <div class="detail-item">
                            <span class="detail-label">Market Cap</span>
                            <span class="detail-value">${formatLargeNumber(stock.marketCap)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Volume</span>
                            <span class="detail-value">${formatVolume(stock.volume)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">High</span>
                            <span class="detail-value">${formatPrice(stock.high)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Low</span>
                            <span class="detail-value">${formatPrice(stock.low)}</span>
                        </div>
                    </div>
                </article>
            `;
        }

        function renderStocks() {
            const grid = document.getElementById('stockGrid');

            if (filteredStocks.length === 0) {
                grid.innerHTML = `
                    <div class="loading-container" style="grid-column: 1 / -1;">
                        <p class="loading-text">No stocks found matching your criteria</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredStocks.map(stock => createStockCard(stock)).join('');
        }

        // ============================================
        // Data Loading & Filtering
        // ============================================
        async function loadStocks() {
            showLoading();

            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 800));

            try {
                stocks = generateMockStocks();
                applyFilters();
                updateLastUpdateTime();
            } catch (error) {
                showError('Failed to fetch market data. Please try again.');
                console.error('Error loading stocks:', error);
            }
        }

        function applyFilters() {
            let filtered = [...stocks];
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(stock =>
                    stock.symbol.toLowerCase().includes(searchTerm) ||
                    stock.name.toLowerCase().includes(searchTerm)
                );
            }

            // Apply category filter
            switch (currentFilter) {
                case 'gain':
                    filtered = filtered.filter(stock => stock.changePercent >= 0);
                    break;
                case 'loss':
                    filtered = filtered.filter(stock => stock.changePercent < 0);
                    break;
                case 'watchlist':
                    filtered = filtered.filter(stock => watchlist.includes(stock.symbol));
                    break;
            }

            filteredStocks = filtered;
            renderStocks();
        }

        // ============================================
        // Watchlist Management
        // ============================================
        function toggleWatchlist(symbol) {
            const index = watchlist.indexOf(symbol);
            if (index > -1) {
                watchlist.splice(index, 1);
            } else {
                watchlist.push(symbol);
            }
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            applyFilters();
        }

        // ============================================
        // Event Handlers
        // ============================================
        document.getElementById('searchInput').addEventListener('input', applyFilters);

        document.getElementById('refreshBtn').addEventListener('click', loadStocks);

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                applyFilters();
            });
        });

        // Help panel controls
        const helpBtn = document.getElementById('helpBtn');
        const shortcutsPanel = document.getElementById('shortcutsPanel');
        const overlay = document.getElementById('overlay');
        const closeShortcuts = document.getElementById('closeShortcuts');

        function showShortcuts() {
            shortcutsPanel.classList.add('show');
            overlay.classList.add('show');
        }

        function hideShortcuts() {
            shortcutsPanel.classList.remove('show');
            overlay.classList.remove('show');
        }

        helpBtn.addEventListener('click', showShortcuts);
        closeShortcuts.addEventListener('click', hideShortcuts);
        overlay.addEventListener('click', hideShortcuts);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in input
            if (document.activeElement.tagName === 'INPUT') {
                if (e.key === 'Escape') {
                    document.activeElement.blur();
                }
                return;
            }

            switch (e.key) {
                case '?':
                    showShortcuts();
                    break;
                case 'Escape':
                    hideShortcuts();
                    break;
                case 'r':
                case 'R':
                    loadStocks();
                    break;
                case '/':
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                    break;
                case '1':
                    document.querySelector('[data-filter="all"]').click();
                    break;
                case '2':
                    document.querySelector('[data-filter="gain"]').click();
                    break;
                case '3':
                    document.querySelector('[data-filter="loss"]').click();
                    break;
                case '4':
                    document.querySelector('[data-filter="watchlist"]').click();
                    break;
            }
        });

        // ============================================
        // Auto-refresh Setup
        // ============================================
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                loadStocks();
            }, 30000); // Refresh every 30 seconds
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                loadStocks();
                startAutoRefresh();
            }
        });

        // ============================================
        // Initialization
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            loadStocks();
            startAutoRefresh();
        });
    </script>
</body>
</html>
