# REQUIREMENTS.md - Text Diff Editor (Innovative Approach)

## 1. プロジェクト概要

### 1.1 プロジェクト名
**Text Diff Editor** - 老眼に優しいテキストエディター

### 1.2 ビジョン
Mac mini M4 + Magic Mouse の操作体験を最大限に活かし、老眼のユーザーでもストレスなくテキスト編集・比較ができるモダンなエディターを実現する。Magic Mouse のマルチタッチジェスチャー（ピンチズーム、二本指スクロール）をネイティブレベルで活用し、60fps を維持したスムーズなズーム・パン体験を提供する。

### 1.3 ターゲットユーザー
- 老眼で小さな文字が見づらいユーザー
- Mac mini M4 + Magic Mouse を使用するデスクトップユーザー
- テキストファイルの編集・比較を頻繁に行うユーザー
- コードレビューや文書比較が必要なユーザー

### 1.4 ターゲット環境
| 項目 | 仕様 |
|------|------|
| ハードウェア | Mac mini M4 + Magic Mouse |
| ブラウザ | Safari 17+ / Chrome 120+ |
| 実行方式 | ローカルHTMLファイル（サーバー不要） |
| コスト | $0（外部API不使用） |
| オフライン | 完全対応（CDN依存なし） |

---

## 2. 機能要件（優先順位付き）

### P1: 最重要機能（MVP必須）

#### F-001: テキスト表示・高機能編集（CodeMirror 6）
- **説明**: CodeMirror 6 をエディターエンジンとして採用し、高速かつ高機能なテキスト編集を実現
- **詳細要件**:
  - テキストファイルの読み込み・表示
  - カーソル操作、選択、コピー&ペースト
  - Undo/Redo（無制限履歴）
  - 行番号表示
  - 折り返し表示切り替え（ソフトラップ / 横スクロール）
  - 検索・置換（正規表現対応）
  - 大規模ファイル対応（10万行以上でも快適動作）
- **受入基準**: 10万行のテキストファイルを開いて2秒以内に表示、編集操作で遅延なし

#### F-002: Magic Mouse ジェスチャー対応（ピンチズーム + 慣性スクロール）
- **説明**: Magic Mouse のマルチタッチジェスチャーでテキスト全体の拡大縮小を直感的に操作
- **詳細要件**:
  - ピンチズーム: テキスト全体のフォントサイズ＋レイアウトを連続的に拡大縮小
  - ズーム範囲: 50% 〜 400%（デフォルト 100%）
  - ズーム中心: マウスカーソル位置を基準にズーム（カーソル直下のテキストが固定される）
  - 慣性スクロール: Magic Mouse の自然な慣性スクロール動作を活用
  - スムーズアニメーション: CSS transform によるGPU加速で60fps維持
  - ズームレベル表示: 現在のズーム率をUIに表示（例: "150%"）
  - ズームリセット: ダブルクリックまたはボタンで100%にリセット
- **技術実装**:
  - `wheel` イベントの `ctrlKey` フラグでピンチズーム検出
  - `CSS transform: scale()` + `transform-origin` でGPU加速レンダリング
  - `will-change: transform` で事前最適化
  - `requestAnimationFrame` でフレーム同期
- **受入基準**: ピンチズーム操作で60fps維持、カーソル位置基準のズームが正確に動作

#### F-003: スムーズなドラッグナビゲーション
- **説明**: ドラッグ操作でテキストの表示位置を自由に移動
- **詳細要件**:
  - ミドルクリック（または修飾キー+ドラッグ）でパンモード起動
  - パン操作中はカーソル形状が `grab` / `grabbing` に変化
  - 慣性付きパン（離した後もスーッと動く）
  - ズーム状態でもパンが正確に動作
  - パン操作はテキスト選択と競合しない
  - パン操作中もエディターの編集機能を阻害しない
- **受入基準**: ドラッグ操作でスムーズにパン、慣性動作が自然

#### F-004: ファイルオープン・保存（File System Access API + 自動保存）
- **説明**: ローカルファイルのオープン・保存を File System Access API で実現
- **詳細要件**:
  - File System Access API によるファイルオープン（ファイルハンドル保持）
  - 同じファイルへの上書き保存（Cmd+S）
  - 名前を付けて保存（Cmd+Shift+S）
  - 自動保存（設定可能：OFF / 30秒 / 1分 / 5分）
  - 未保存変更の検出（タイトルバーにインジケーター表示 ● ）
  - ファイル変更時の確認ダイアログ（未保存状態でタブ閉じ/ファイル切り替え時）
  - ドラッグ&ドロップでのファイルオープン対応
  - フォールバック: File System Access API 非対応ブラウザでは `<input type="file">` + Blob ダウンロード
- **受入基準**: Cmd+S で即座に保存、自動保存が設定通りに動作、未保存インジケーター表示

#### F-005: 2ファイル同時表示（サイドバイサイド Diff ビュー）
- **説明**: 2つのファイルを左右に並べて表示し、差分をハイライト
- **詳細要件**:
  - 左右分割レイアウト（リサイズ可能なスプリッター）
  - 各パネルは独立して編集可能
  - 差分ハイライト表示:
    - 追加行: 緑背景
    - 削除行: 赤背景
    - 変更行: 黄背景（行内差分はインライン強調）
  - スクロール同期: 左右パネルの同期スクロール（ON/OFF切り替え可能）
  - ズーム同期: 左右パネルが同じズームレベルで連動
  - 差分ナビゲーション: 「次の差分」「前の差分」ボタンでジャンプ
  - 差分サマリー: 追加/削除/変更行数の表示
  - 単一ファイルモードとの切り替え（ワンクリック）
  - diff アルゴリズム: Myers diff（行単位）+ 行内文字差分
- **受入基準**: 2ファイル表示でスクロール同期が正確、差分ハイライトが正しく表示

### P2: 重要機能（UX向上）

#### F-006: シンタックスハイライト（多言語対応）
- **説明**: CodeMirror 6 の言語拡張で主要言語のシンタックスハイライト
- **詳細要件**:
  - 対応言語: JavaScript, TypeScript, Python, HTML, CSS, JSON, Markdown, YAML, XML, SQL, Shell, Go, Rust, Java, C/C++
  - ファイル拡張子からの自動検出
  - 手動での言語切り替え
  - ハイライトはズーム時も正確に表示
- **受入基準**: 主要15言語でハイライトが正しく動作

#### F-007: ミニマップナビゲーション
- **説明**: エディター右端にファイル全体のミニマップを表示
- **詳細要件**:
  - ファイル全体の縮小ビュー表示
  - 現在の表示範囲をハイライト
  - ミニマップ上でクリック/ドラッグで位置移動
  - ズーム状態に応じて表示範囲が変化
  - ON/OFF切り替え可能
- **受入基準**: ミニマップが正確にファイル全体を反映し、クリックで即座にジャンプ

#### F-008: テーマ切り替え（ダーク / ライト / ハイコントラスト）
- **説明**: 3つのテーマを切り替え可能。老眼ユーザー向けにハイコントラストテーマを用意
- **詳細要件**:
  - ライトテーマ: 白背景、黒テキスト（デフォルト）
  - ダークテーマ: 暗い背景、明るいテキスト
  - ハイコントラストテーマ: 黒背景、大きな白テキスト、太字のコントラスト（老眼最適化）
  - システムテーマ連動（`prefers-color-scheme` メディアクエリ）
  - テーマ選択の永続化（localStorage）
  - テーマ切り替え時のスムーズなトランジション
- **受入基準**: 3テーマが正しく切り替わり、ハイコントラストテーマが老眼ユーザーに適切

#### F-009: フォントサイズ・フォントファミリー設定
- **説明**: ベースとなるフォントサイズとフォントファミリーを設定可能
- **詳細要件**:
  - ベースフォントサイズ: 12px 〜 48px（スライダーで調整）
  - フォントファミリー: モノスペース系を複数選択可能
    - デフォルト: `"SF Mono", "Menlo", "Monaco", "Consolas", monospace`
    - オプション: `"Fira Code"`, `"JetBrains Mono"`, `"Source Code Pro"`
  - 行間（line-height）: 1.2 〜 2.5（スライダーで調整）
  - 設定の永続化（localStorage）
- **受入基準**: フォント設定がリアルタイムに反映され、永続化される

### P3: 付加価値機能（差別化）

#### F-010: キーバインドカスタマイズ
- **説明**: Vim / Emacs / VS Code 風のキーバインド切り替え
- **詳細要件**:
  - デフォルト（標準）キーバインド
  - Vim モード（CodeMirror vim 拡張）
  - Emacs モード（CodeMirror emacs 拡張）
  - カスタムショートカット定義
- **受入基準**: 3つのキーバインドモードが正しく動作

#### F-011: セッション復元
- **説明**: 前回のセッション状態を復元
- **詳細要件**:
  - 開いていたファイルの記憶（ファイル名のみ、内容はセキュリティ上保持しない）
  - ズームレベル、テーマ、フォント設定の復元
  - カーソル位置の復元
  - 分割モード状態の復元
  - IndexedDB による永続化
- **受入基準**: ブラウザ再起動後に前回の設定が復元される

#### F-012: アクセシビリティ強化
- **説明**: WCAG 2.1 AA 準拠のアクセシビリティ対応
- **詳細要件**:
  - キーボードのみでの完全操作
  - スクリーンリーダー対応（ARIA属性）
  - フォーカス表示の明確化（アウトライン）
  - 色のコントラスト比 4.5:1 以上
  - 高DPIディスプレイ対応
- **受入基準**: WCAG 2.1 AA チェッカーで主要項目合格

---

## 3. 非機能要件

### 3.1 パフォーマンス要件
| 項目 | 基準 | 計測方法 |
|------|------|----------|
| 初回表示（LCP） | < 1.5秒 | Lighthouse |
| ズーム操作 | 60fps維持 | Performance Monitor |
| ファイルオープン（1MB） | < 1秒 | パフォーマンスタイマー |
| ファイルオープン（10MB） | < 3秒 | パフォーマンスタイマー |
| メモリ使用量（10万行） | < 200MB | DevTools Memory |
| diff計算（1万行） | < 500ms | パフォーマンスタイマー |
| 入力遅延（FID） | < 50ms | Lighthouse |
| レイアウトシフト（CLS） | < 0.05 | Lighthouse |
| 保存操作 | < 200ms | パフォーマンスタイマー |

### 3.2 ブラウザ互換性
| ブラウザ | 最低バージョン | 備考 |
|----------|---------------|------|
| Safari | 17+ | File System Access API 部分サポート |
| Chrome | 120+ | 全機能サポート |
| Firefox | 120+ | File System Access API 非サポート（フォールバック使用） |
| Edge | 120+ | 全機能サポート |

### 3.3 セキュリティ要件
- ファイル内容をサーバーに送信しない（完全ローカル処理）
- `Content-Security-Policy` ヘッダー設定（インラインスクリプト制御）
- XSS対策: ユーザー入力のサニタイズ
- ファイルアクセスはユーザーの明示的許可のみ

### 3.4 拡張性要件
- モジュラーアーキテクチャ（ES Modules）
- CodeMirror 6 の拡張API活用で機能追加が容易
- テーマはCSS Custom Propertiesで定義し、追加テーマの作成が容易
- diff アルゴリズムは差し替え可能

---

## 4. 技術スタック提案（革新的アプローチ）

### 4.1 コアエンジン
| コンポーネント | 技術 | 理由 |
|---------------|------|------|
| エディター | CodeMirror 6 | 高速・モジュラー・拡張性抜群、仮想レンダリングで大ファイル対応 |
| ズーム | CSS `transform: scale()` + `will-change` | GPU加速で60fps維持 |
| Diff | diff-match-patch（Googleライブラリ）をバンドル | 高精度な行単位＋文字単位差分 |
| ファイルI/O | File System Access API | ネイティブレベルのファイル操作 |
| 永続化 | localStorage + IndexedDB | 設定とセッション復元 |
| ビルド | Vite（開発時）→ 単一HTMLにバンドル | ゼロ依存の配布物 |

### 4.2 フロントエンド構成
```
project/
├── public/
│   └── index.html          # 単一HTMLエントリーポイント（バンドル結果）
├── src/
│   ├── main.js              # エントリーポイント
│   ├── editor/
│   │   ├── EditorManager.js  # CodeMirror 6 ラッパー
│   │   ├── DiffEngine.js     # diff-match-patch ラッパー
│   │   └── extensions/       # CodeMirror 拡張
│   ├── zoom/
│   │   ├── ZoomController.js # ズーム制御（ピンチ検出＋CSS transform）
│   │   └── PanController.js  # パン制御（ドラッグ＋慣性）
│   ├── file/
│   │   ├── FileManager.js    # File System Access API ラッパー
│   │   └── AutoSave.js       # 自動保存
│   ├── ui/
│   │   ├── SplitView.js      # 左右分割ビュー
│   │   ├── Toolbar.js        # ツールバー
│   │   ├── StatusBar.js      # ステータスバー
│   │   ├── Minimap.js        # ミニマップ
│   │   └── Settings.js       # 設定パネル
│   ├── theme/
│   │   ├── ThemeManager.js   # テーマ管理
│   │   ├── light.css         # ライトテーマ
│   │   ├── dark.css          # ダークテーマ
│   │   └── high-contrast.css # ハイコントラストテーマ
│   └── utils/
│       ├── EventBus.js       # イベントバス（コンポーネント間通信）
│       └── Storage.js        # localStorage/IndexedDB ラッパー
├── tests/
│   ├── editor.test.js
│   ├── zoom.test.js
│   ├── diff.test.js
│   └── file.test.js
└── vite.config.js
```

### 4.3 バンドル戦略
- **開発時**: Vite の HMR（Hot Module Replacement）で高速開発
- **本番ビルド**: `vite-plugin-singlefile` で全アセットを単一 `index.html` にインライン化
- **配布物**: `index.html` 1ファイルのみ（CDN依存なし、オフライン完全対応）
- **サイズ目標**: 500KB以下（gzip後）

---

## 5. UI/UX デザインコンセプト

### 5.1 レイアウト構成
```
┌─────────────────────────────────────────────────────┐
│ ToolBar: [📂Open] [💾Save] [📑Split] [🔍Search]     │
│          [Theme🌙] [Font▲▼] [Zoom: 150%] [Settings⚙]│
├─────────────────────────┬───────────────────────────┤
│                         │                           │
│  Editor Panel 1         │  Editor Panel 2           │
│  (CodeMirror 6)         │  (CodeMirror 6)           │
│                         │                           │
│  [Minimap]              │  [Minimap]                │
│                         │                           │
│  ← Zoom & Pan →         │  ← Zoom & Pan →           │
│                         │                           │
├─────────────────────────┴───────────────────────────┤
│ StatusBar: Ln 42, Col 15 | UTF-8 | JS | 150% | ●   │
└─────────────────────────────────────────────────────┘
```

### 5.2 老眼対策UXの革新
1. **スマートズーム**: ピンチズームでカーソル位置基準の拡大（Figma/Miro風）
2. **ズームプリセット**: 100% / 150% / 200% / 250% のクイック切り替えボタン
3. **フォーカスモード**: 選択行のみをハイライトし、周囲を薄暗く表示
4. **ハイコントラストテーマ**: 黒背景に大きな白テキスト（老眼特化）
5. **マウスカーソル拡大**: ズームレベルに応じてカーソルも拡大
6. **行間拡大**: デフォルトで行間1.6（通常の1.2より広い）
7. **現在行ハイライト**: 編集中の行を常にハイライト表示

### 5.3 インタラクション設計
| 操作 | アクション | フィードバック |
|------|-----------|--------------|
| ピンチイン/アウト | ズーム | ズーム率表示 + アニメーション |
| 二本指スクロール | スクロール | 慣性付きスクロール |
| Alt+ドラッグ | パン | カーソル形状変化 (grab/grabbing) |
| ダブルクリック余白 | ズームリセット (100%) | アニメーション付きリセット |
| Cmd+S | 保存 | トースト通知 "保存しました" |
| Cmd+O | ファイルオープン | ファイルピッカー |
| Cmd++ / Cmd+- | ズームイン/アウト | ステップズーム (25%単位) |
| Cmd+0 | ズームリセット | 100%にリセット |

---

## 6. リスクと対策

### 6.1 技術リスク

| リスク | 影響度 | 確率 | 対策 |
|--------|--------|------|------|
| CodeMirror 6 バンドルサイズ大 | 中 | 高 | Tree-shaking + 必要な拡張のみ選択的インポート |
| File System Access API の Safari 制限 | 中 | 高 | フォールバック実装（input[type=file] + Blob） |
| CSS transform ズームでのテキスト描画品質 | 高 | 中 | `image-rendering: crisp-edges` + `text-rendering: optimizeLegibility` |
| 大ファイル（10万行超）でのdiff計算遅延 | 中 | 中 | Web Worker での非同期diff計算 + プログレス表示 |
| ピンチズームとブラウザネイティブズームの競合 | 高 | 高 | `touch-action: none` + `event.preventDefault()` で制御 |
| Vite 単一ファイルバンドルの制約 | 低 | 低 | `vite-plugin-singlefile` の実績あり |

### 6.2 UXリスク

| リスク | 影響度 | 確率 | 対策 |
|--------|--------|------|------|
| ズーム操作が直感的でない | 高 | 中 | ツールチップ/オンボーディング表示 |
| パン操作とテキスト選択の競合 | 高 | 高 | 修飾キー（Alt）でモード切り替え |
| diff表示が見づらい（色覚多様性） | 中 | 低 | 色+記号（+/-）の二重表示、カラーカスタマイズ |
| 設定が多すぎて混乱 | 中 | 中 | デフォルト設定の最適化、プリセット提供 |

### 6.3 リスク緩和優先順位
1. **最優先**: ピンチズーム動作の安定化（ブラウザ互換性テスト）
2. **高**: File System Access API のフォールバック実装
3. **中**: 大ファイル対応のパフォーマンス最適化
4. **低**: 全テーマの色覚多様性対応

---

## 7. 成功指標

### 7.1 定量指標
| 指標 | 目標 |
|------|------|
| 初回表示速度（LCP） | < 1.5秒 |
| ズーム操作フレームレート | 60fps |
| ファイルオープン（1MB） | < 1秒 |
| diff計算（1万行） | < 500ms |
| バンドルサイズ（gzip後） | < 500KB |
| テストカバレッジ | > 80% |

### 7.2 定性指標
- Magic Mouse のピンチズームが「ネイティブアプリ並み」にスムーズ
- 老眼ユーザーがフォントサイズ設定を意識せずに快適に閲覧できる
- 2ファイル比較でdiff箇所がひと目で分かる
- ファイル保存がストレスなく行える

---

## 8. 制約条件

### 8.1 技術制約
- ローカル実行（サーバーサイド処理なし）
- 外部API呼び出しなし（$0コスト）
- CDN依存なし（オフライン完全対応）
- 最終成果物は単一HTMLファイル（CodeMirror 6 含む全バンドル）

### 8.2 実装制約
- フレームワークなし（Vanilla JS + CodeMirror 6）
- ビルドツール: Vite（開発時のみ、本番は単一HTML）
- テストフレームワーク: Vitest（Vite統合）
- ブラウザ標準API最大活用

### 8.3 スコープ外
- マルチユーザー同時編集
- クラウドストレージ連携
- バージョン管理（Git連携）
- プラグインシステム
- モバイル対応（デスクトップ専用）
