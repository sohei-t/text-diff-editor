# SPEC.md - Text Diff Editor 詳細仕様書

## 1. ユースケース一覧

### UC-001: 新規テキストを作成する
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | アプリが起動済み |
| 入力 | ツールバーの「New」ボタンクリック、または Cmd+N |
| 処理 | 1. 未保存変更がある場合、確認ダイアログを表示<br>2. エディターの内容をクリア<br>3. ファイルハンドルをリセット<br>4. ステータスバーを「Untitled」に更新 |
| 出力 | 空白のエディター画面 |
| エラーケース | E-001: 確認ダイアログでキャンセル → 何もしない |
| 優先度 | P1 |

### UC-002: ファイルを開く
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | アプリが起動済み |
| 入力 | (a) ツールバーの「Open」ボタン / Cmd+O<br>(b) ファイルのドラッグ&ドロップ |
| 処理 | 1. 未保存変更がある場合、確認ダイアログを表示<br>2a. File System Access API対応ブラウザ: showOpenFilePicker()でファイル選択、ファイルハンドルを保持<br>2b. 非対応ブラウザ: input[type=file]で選択<br>3. file.text()でテキスト内容を取得<br>4. エディターにテキストを設定<br>5. ファイル名をステータスバーに表示<br>6. 未保存フラグをクリア |
| 出力 | ファイル内容がエディターに表示される |
| エラーケース | E-002a: ファイル選択キャンセル → 何もしない<br>E-002b: ファイル読み込みエラー → トースト通知「ファイルを開けませんでした」<br>E-002c: バイナリファイル → 警告「テキストファイルではない可能性があります」 |
| 優先度 | P1 |

### UC-003: テキストを編集する
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | エディターにテキストが表示済み |
| 入力 | キーボード入力、カット、コピー、ペースト |
| 処理 | 1. textarea要素でテキスト入力を受付<br>2. 入力のたびに未保存フラグをセット<br>3. ステータスバーのカーソル位置（行・列）を更新<br>4. Undo/Redo履歴に操作を記録<br>5. 自動保存タイマーをリセット（有効時） |
| 出力 | 編集内容がリアルタイムに反映される |
| エラーケース | なし（基本操作） |
| 優先度 | P1 |

### UC-004: Magic Mouseでズームイン/アウト
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | エディターにテキストが表示済み |
| 入力 | (a) Magic Mouseのピンチジェスチャー（wheelイベント + ctrlKey）<br>(b) Cmd++ / Cmd+-（キーボード）<br>(c) ツールバーのズームプリセットボタン |
| 処理 | 1. wheelイベントでctrlKeyフラグを検出<br>2. deltaYから変化量を計算<br>3. 新しいズームレベルを算出（範囲: 50%~400%）<br>4. マウスカーソル位置を基準にtransform-originを設定<br>5. CSS transform: scale()を適用（GPU加速）<br>6. requestAnimationFrameでフレーム同期<br>7. ステータスバーのズーム率を更新 |
| 出力 | テキストがマウスカーソル位置を中心にズームイン/アウト |
| エラーケース | E-004a: ズーム範囲外 → 最小50%/最大400%にクランプ<br>E-004b: ブラウザネイティブズームとの競合 → event.preventDefault()で抑止 |
| 優先度 | P1 |

### UC-005: ドラッグでテキスト位置を調整（パン）
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | テキストが表示済み（特にズーム状態時に有効） |
| 入力 | Alt + マウスドラッグ |
| 処理 | 1. Altキー押下中のmousedownでパンモード開始<br>2. カーソル形状をgrab→grabbingに変更<br>3. mousemoveでscrollLeft/scrollTopを更新<br>4. mouseupで慣性アニメーション開始<br>5. 速度の指数減衰（摩擦係数0.95）で自然に停止 |
| 出力 | テキスト表示位置がドラッグ方向に移動する |
| エラーケース | E-005a: テキスト選択との競合 → Altキー修飾で分離<br>E-005b: エリア外でマウスアップ → documentレベルでイベント捕捉 |
| 優先度 | P1 |

### UC-006: 2つのファイルを並べて表示（Diff表示）
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | 少なくとも1つのファイルが開いている |
| 入力 | ツールバーの「Split」ボタン / Cmd+\\ |
| 処理 | 1. 分割モードをトグル<br>2. 分割ON: 左右にエディターパネルを配置<br>3. リサイズ可能なスプリッターを中央に表示<br>4. 右パネルにファイルを開く<br>5. 両ファイルのテキストでdiff計算実行<br>6. 差分箇所をハイライト表示（追加=緑/削除=赤/変更=黄）<br>7. スクロール同期を有効化<br>8. ズーム同期を有効化 |
| 出力 | 左右に2つのファイルが表示され、差分がハイライトされる |
| エラーケース | E-006a: 2つ目のファイル選択キャンセル → 分割のみ（差分なし）<br>E-006b: 大ファイルのdiff計算遅延 → プログレス表示 |
| 優先度 | P1 |

### UC-007: テキスト検索
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | エディターにテキストが表示済み |
| 入力 | Cmd+F で検索バーを表示、検索文字列を入力 |
| 処理 | 1. 検索バーを表示（エディター上部）<br>2. 入力文字列をリアルタイム検索<br>3. 一致箇所をハイライト表示<br>4. 現在の一致位置/全一致数を表示（例: 3/15）<br>5. Enter/Shift+Enter で次/前の一致箇所にジャンプ<br>6. 大文字小文字の区別切り替え<br>7. 正規表現モード切り替え |
| 出力 | 一致箇所がハイライトされ、ジャンプナビゲーション可能 |
| エラーケース | E-007a: 一致なし → 「見つかりません」表示<br>E-007b: 不正な正規表現 → エラー表示 |
| 優先度 | P1 |

### UC-008: テキスト置換
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | 検索バーが表示されている |
| 入力 | Cmd+H / 検索バーの展開ボタンで置換モードへ |
| 処理 | 1. 置換入力フィールドを表示<br>2. 「置換」: 現在の一致箇所を置換文字列に変更<br>3. 「すべて置換」: 全一致箇所を一括置換<br>4. 置換のたびにUndoスタックに記録<br>5. 差分モード時は差分ハイライトを再計算 |
| 出力 | 一致箇所が置換文字列に変更される |
| エラーケース | E-008a: 読み取り専用ファイル → 「このファイルは読み取り専用です」 |
| 優先度 | P2 |

### UC-009: テーマ切り替え
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | アプリが起動済み |
| 入力 | ツールバーのテーマ切り替えボタン / 設定パネル |
| 処理 | 1. 現在のテーマを次のテーマに切り替え（Light→Dark→High Contrast→Light）<br>2. CSS Custom Propertiesを変更<br>3. トランジションアニメーション（0.3秒フェード）<br>4. 選択をlocalStorageに保存 |
| 出力 | UIのカラースキームが即座に変更される |
| エラーケース | なし |
| 優先度 | P2 |

### UC-010: ファイルを保存する
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | エディターにテキストが表示済み |
| 入力 | (a) Cmd+S（上書き保存）<br>(b) Cmd+Shift+S（名前を付けて保存） |
| 処理（上書き保存）| 1. ファイルハンドルが存在するか確認<br>2a. ハンドルあり: createWritable()で書き込みストリーム取得 → write() → close()<br>2b. ハンドルなし: showSaveFilePicker()でファイル選択 → 上記と同じ<br>2c. フォールバック: Blobを作成 → aタグのdownload属性でダウンロード<br>3. 未保存フラグをクリア<br>4. トースト通知「保存しました」 |
| 処理（名前を付けて保存）| 1. showSaveFilePicker()でファイル選択<br>2. 新しいハンドルで保存<br>3. ファイル名を更新 |
| 出力 | ファイルがディスクに保存される |
| エラーケース | E-010a: 保存キャンセル → 何もしない<br>E-010b: 書き込みエラー → トースト通知「保存に失敗しました」<br>E-010c: 権限拒否 → 再度権限要求 |
| 優先度 | P1 |

### UC-011: 差分ナビゲーション
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | 分割モードで差分が表示されている |
| 入力 | ツールバーの「次の差分」「前の差分」ボタン / F7, Shift+F7 |
| 処理 | 1. 差分リストから次/前の差分チャンクを取得<br>2. 該当行までスクロール<br>3. 差分チャンクをフォーカスハイライト<br>4. ステータスバーに「差分 3/12」と表示 |
| 出力 | 差分箇所にジャンプし、ハイライトされる |
| エラーケース | E-011a: 最後の差分で「次」→ 先頭に戻る（ラップアラウンド） |
| 優先度 | P2 |

### UC-012: フォントサイズ・フォントファミリー設定
| 項目 | 内容 |
|------|------|
| アクター | ユーザー |
| 事前条件 | アプリが起動済み |
| 入力 | 設定パネル / ツールバーのフォントサイズ調整ボタン |
| 処理 | 1. フォントサイズスライダー操作（12px~48px）<br>2. フォントファミリー選択ドロップダウン<br>3. 行間スライダー操作（1.2~2.5）<br>4. リアルタイムプレビュー<br>5. localStorageに保存 |
| 出力 | エディターのフォント設定が即座に反映 |
| エラーケース | なし |
| 優先度 | P2 |

---

## 2. 画面構成

### 2.1 全体レイアウト

```
┌─────────────────────────────────────────────────────────────────┐
│ Toolbar                                                         │
│ [New] [Open] [Save] | [Split] [Sync Scroll] | [Search]          │
│ [Theme: Light/Dark/HC] | [Font ▲▼] | [Zoom: 100%] [Settings]   │
├───────────────────────────────┬─────────────────────────────────┤
│                               │                                 │
│   Editor Panel 1 (Left)       │   Editor Panel 2 (Right)        │
│   ┌──────────────────────┐    │   ┌──────────────────────┐      │
│   │ 1  function hello() {│    │   │ 1  function hello() {│      │
│   │ 2    console.log('hi │    │   │ 2    console.log('he │      │
│   │ 3  }                 │    │   │ 3    return true;    │      │
│   │ 4                    │    │   │ 4  }                 │      │
│   └──────────────────────┘    │   └──────────────────────┘      │
│                               │                                 │
│   [Search Bar]                │   [Search Bar]                  │
│                               │                                 │
├───────────────────────────────┴─────────────────────────────────┤
│ StatusBar: Untitled | Ln 1, Col 1 | UTF-8 | Zoom: 100% | ●     │
│           [Diff: +5 -3 ~2] [Split: ON] [Scroll Sync: ON]       │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 ツールバー詳細

| セクション | ボタン/コントロール | アクション |
|-----------|-------------------|-----------|
| ファイル操作 | New | 新規テキスト作成 |
| | Open | ファイルを開く |
| | Save | 上書き保存 |
| 表示操作 | Split | 分割表示トグル |
| | Sync Scroll | スクロール同期トグル（分割時のみ有効） |
| 検索 | Search | 検索バー表示 |
| テーマ | Theme | Light/Dark/High Contrast切り替え |
| フォント | Font ▲▼ | ベースフォントサイズ増減（4px刻み） |
| ズーム | Zoom表示 | 現在のズーム率表示（クリックでリセット） |
| | Zoom Presets | 100% / 150% / 200% / 300% クイック切り替え |
| 設定 | Settings | 設定パネル表示 |

### 2.3 検索バー

```
┌─────────────────────────────────────────────────┐
│ [🔍 検索文字列          ] [Aa] [.*] [↑] [↓] [✕] │
│ [  置換文字列           ] [置換] [すべて置換]     │
│                                    3 / 15 件一致  │
└─────────────────────────────────────────────────┘
```

| コントロール | 説明 |
|-------------|------|
| 検索入力 | 検索文字列入力フィールド |
| Aa | 大文字小文字区別トグル |
| .* | 正規表現モードトグル |
| ↑ / ↓ | 前/次の一致箇所へジャンプ |
| ✕ | 検索バーを閉じる |
| 置換入力 | 置換文字列入力フィールド（展開時表示） |
| 置換 | 現在の一致箇所を置換 |
| すべて置換 | 全一致箇所を一括置換 |

### 2.4 設定パネル

| カテゴリ | 設定項目 | コントロール | デフォルト値 |
|---------|---------|-------------|-------------|
| フォント | ベースフォントサイズ | スライダー (12-48px) | 16px |
| | フォントファミリー | ドロップダウン | SF Mono |
| | 行間 | スライダー (1.2-2.5) | 1.6 |
| | 行の折り返し | トグル | ON |
| テーマ | テーマ選択 | ラジオボタン 3つ | Light |
| | システムテーマ連動 | トグル | OFF |
| 保存 | 自動保存 | ドロップダウン (OFF/30秒/1分/5分) | OFF |
| 表示 | 行番号表示 | トグル | ON |
| | 現在行ハイライト | トグル | ON |
| | ミニマップ表示 | トグル | OFF |

---

## 3. データモデル

### 3.1 EditorState

```javascript
/**
 * エディターの状態を管理するデータモデル
 */
const EditorState = {
  // テキスト内容
  content: '',              // エディターのテキスト内容

  // カーソル状態
  cursor: {
    line: 1,                // 行番号（1始まり）
    column: 1,              // 列番号（1始まり）
    selectionStart: 0,      // 選択開始位置
    selectionEnd: 0         // 選択終了位置
  },

  // Undo/Redo履歴
  history: {
    undoStack: [],          // 元に戻す操作スタック
    redoStack: [],          // やり直し操作スタック
    maxEntries: 1000        // 履歴の最大エントリ数
  },

  // 変更状態
  modified: false,          // 未保存変更フラグ

  // 検索状態
  search: {
    query: '',              // 検索文字列
    caseSensitive: false,   // 大文字小文字区別
    useRegex: false,        // 正規表現モード
    matches: [],            // 一致箇所リスト [{start, end}]
    currentIndex: -1        // 現在の一致箇所インデックス
  }
};
```

### 3.2 FileState

```javascript
/**
 * ファイルの状態を管理するデータモデル
 */
const FileState = {
  name: 'Untitled',         // ファイル名
  handle: null,             // FileSystemFileHandle（対応ブラウザのみ）
  encoding: 'UTF-8',       // 文字エンコーディング
  size: 0,                 // ファイルサイズ（バイト）
  lastSaved: null,         // 最終保存日時 (Date)
  autoSaveTimer: null      // 自動保存タイマーID
};
```

### 3.3 ViewState

```javascript
/**
 * 表示・UI状態を管理するデータモデル
 */
const ViewState = {
  // ズーム状態
  zoom: {
    level: 1.0,             // ズームレベル（0.5 ~ 4.0）
    originX: 50,            // transform-origin X（%）
    originY: 50             // transform-origin Y（%）
  },

  // 分割表示状態
  split: {
    enabled: false,         // 分割モード
    ratio: 0.5,             // 分割比率（0.2 ~ 0.8）
    syncScroll: true,       // スクロール同期
    syncZoom: true          // ズーム同期
  },

  // テーマ・フォント設定
  appearance: {
    theme: 'light',                  // 'light' | 'dark' | 'high-contrast'
    fontSize: 16,                    // ベースフォントサイズ（px）
    fontFamily: '"SF Mono", "Menlo", "Monaco", "Consolas", monospace',
    lineHeight: 1.6,                 // 行間
    wordWrap: true,                  // 折り返し
    showLineNumbers: true,           // 行番号表示
    highlightCurrentLine: true,      // 現在行ハイライト
    showMinimap: false               // ミニマップ表示
  },

  // 差分表示状態
  diff: {
    changes: [],             // 差分チャンクリスト
    stats: { added: 0, deleted: 0, modified: 0, unchanged: 0 },
    currentChangeIndex: -1   // 現在の差分ナビゲーション位置
  },

  // 設定パネル状態
  settingsOpen: false,

  // 検索バー状態
  searchBarOpen: false,

  // 自動保存設定
  autoSave: {
    enabled: false,
    interval: 0             // ミリ秒（0=OFF, 30000, 60000, 300000）
  }
};
```

### 3.4 DiffChunk

```javascript
/**
 * 差分チャンクのデータモデル
 */
const DiffChunk = {
  type: 'add',              // 'add' | 'delete' | 'modify' | 'equal'
  lineLeft: null,           // 左パネルの行番号（deleteの場合null）
  lineRight: null,          // 右パネルの行番号（addの場合null）
  contentLeft: '',          // 左パネルのテキスト
  contentRight: '',         // 右パネルのテキスト
  inlineDiffs: []           // 行内差分 [{type, text}]（modifyの場合のみ）
};
```

---

## 4. キーボードショートカット一覧

### 4.1 ファイル操作

| ショートカット | アクション | 対応UC |
|--------------|-----------|--------|
| Cmd+N | 新規テキスト | UC-001 |
| Cmd+O | ファイルを開く | UC-002 |
| Cmd+S | 上書き保存 | UC-010 |
| Cmd+Shift+S | 名前を付けて保存 | UC-010 |

### 4.2 編集操作

| ショートカット | アクション | 対応UC |
|--------------|-----------|--------|
| Cmd+Z | 元に戻す | UC-003 |
| Cmd+Shift+Z | やり直し | UC-003 |
| Cmd+A | 全選択 | UC-003 |
| Cmd+C | コピー | UC-003 |
| Cmd+X | カット | UC-003 |
| Cmd+V | ペースト | UC-003 |

### 4.3 検索・置換

| ショートカット | アクション | 対応UC |
|--------------|-----------|--------|
| Cmd+F | 検索 | UC-007 |
| Cmd+H | 置換 | UC-008 |
| Enter（検索時） | 次の一致箇所 | UC-007 |
| Shift+Enter（検索時） | 前の一致箇所 | UC-007 |
| Escape | 検索バーを閉じる | UC-007 |

### 4.4 表示操作

| ショートカット | アクション | 対応UC |
|--------------|-----------|--------|
| Cmd++ / Cmd+= | ズームイン（25%刻み） | UC-004 |
| Cmd+- | ズームアウト（25%刻み） | UC-004 |
| Cmd+0 | ズームリセット（100%） | UC-004 |
| Cmd+\\ | 分割表示トグル | UC-006 |
| Alt+ドラッグ | パン（表示位置移動） | UC-005 |

### 4.5 差分ナビゲーション

| ショートカット | アクション | 対応UC |
|--------------|-----------|--------|
| F7 | 次の差分 | UC-011 |
| Shift+F7 | 前の差分 | UC-011 |

---

## 5. 制約・前提条件

### 5.1 技術制約
- **Vanilla JS のみ**: npm、bundler（Vite等）は使用しない
- **外部CDN不使用**: オフライン完全動作を保証
- **配布形式**: 単一HTMLファイル、またはHTML + 最小限のJS/CSSファイル
- **バックエンドなし**: 完全にブラウザ内で動作

### 5.2 ブラウザ対応
| ブラウザ | バージョン | File System Access API | 備考 |
|---------|-----------|----------------------|------|
| Safari | 17+ | 非対応 | フォールバック使用 |
| Chrome | 120+ | 対応 | 全機能利用可能 |
| Firefox | 120+ | 非対応 | フォールバック使用 |
| Edge | 120+ | 対応 | 全機能利用可能 |

### 5.3 パフォーマンス目標
| 項目 | 目標値 |
|------|--------|
| 初回表示（LCP） | < 1.5秒 |
| ズーム操作 | 60fps |
| ファイルオープン（1MB） | < 1秒 |
| diff計算（1万行） | < 500ms |
| 保存操作 | < 200ms |
| メモリ使用量（1万行） | < 100MB |

### 5.4 スコープ外
- マルチユーザー同時編集
- クラウドストレージ連携
- バージョン管理（Git連携）
- プラグインシステム
- モバイル対応（デスクトップ専用）
- シンタックスハイライト（外部ライブラリなしのため、将来拡張として検討）
